// Alchemy by Arkane - Database Schema
// Multi-Brand AI Content Platform

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ============================================
// USER & AUTHENTICATION
// ============================================

model User {
  id        String   @id @default(uuid())
  email     String   @unique
  name      String?
  avatarUrl String?  @map("avatar_url")

  // Timestamps
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  // Relationships
  brands        Brand[]
  ideas         Idea[]
  contentQueue  ContentQueue[]
  publications  Publication[]

  @@map("users")
}

// ============================================
// MULTI-BRAND ARCHITECTURE
// ============================================

model Brand {
  id          String  @id @default(uuid())
  userId      String  @map("user_id")

  // Brand Identity
  name        String
  slug        String  @unique
  description String? @db.Text
  logoUrl     String? @map("logo_url")
  websiteUrl  String? @map("website_url")

  // Brand Voice Configuration
  brandVoice  Json?   @map("brand_voice")
  // Structure: {
  //   tone: "professional" | "casual" | "friendly" | "authoritative" | "playful"
  //   formality: "formal" | "informal" | "conversational"
  //   personality: string[]
  //   vocabulary: { preferred: string[], avoid: string[] }
  //   writingStyle: "concise" | "detailed" | "storytelling"
  // }

  // Target Audience
  targetAudience Json? @map("target_audience")
  // Structure: {
  //   demographics: { age: string, location: string[], profession: string[] }
  //   psychographics: { interests: string[], painPoints: string[], goals: string[] }
  //   expertise: "beginner" | "intermediate" | "expert"
  // }

  // Content Preferences
  contentPreferences Json? @map("content_preferences")
  // Structure: {
  //   contentTypes: string[]  // "blog", "social", "video", "email"
  //   platforms: string[]     // "linkedin", "twitter", "youtube"
  //   toneGuidelines: string
  //   styleGuide: string
  //   keywords: string[]
  //   prohibitedTopics: string[]
  // }

  // Settings
  isDefault   Boolean @default(false) @map("is_default")
  isActive    Boolean @default(true) @map("is_active")

  // Timestamps
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")

  // Relationships
  user            User             @relation(fields: [userId], references: [id], onDelete: Cascade)
  ideas           Idea[]
  contentQueue    ContentQueue[]
  generatedContent GeneratedContent[]
  publications    Publication[]
  discoveryConfig DiscoveryConfig?
  discoveryRuns   DiscoveryRun[]

  @@index([userId])
  @@index([slug])
  @@map("brands")
}

// ============================================
// CONTENT IDEAS & RESEARCH
// ============================================

model Idea {
  id              String    @id @default(uuid())
  userId          String    @map("user_id")
  brandId         String?   @map("brand_id")

  // Content
  title           String
  description     String?   @db.Text
  keywords        String[]
  contentBrief    String?   @db.Text @map("content_brief")

  // Source & Discovery
  source          String    // "manual", "reddit", "youtube", "twitter", "seo", "firecrawl"
  sourceUrl       String?   @map("source_url")
  sourceId        String?   @map("source_id")  // External ID from source platform
  sourceData      Json?     @map("source_data")
  discoveredAt    DateTime? @map("discovered_at")

  // Classification
  targetPlatforms String[]  @map("target_platforms") // ["blog", "youtube", "linkedin"]
  contentType     String?   @map("content_type")     // "how-to", "listicle", "case-study"
  targetAudience  String?   @map("target_audience")
  category        String?   // Auto-categorized topic
  tags            String[]

  // Scoring & Metrics (0-100 scale)
  viralityScore    Float?   @default(0) @map("virality_score")
  relevanceScore   Float?   @default(0) @map("relevance_score")
  competitionScore Float?   @default(0) @map("competition_score") // Inverse: 100 = low competition
  timelinessScore  Float?   @default(0) @map("timeliness_score")
  overallScore     Float?   @default(0) @map("overall_score")     // Weighted composite

  // Detailed Metrics
  metrics         Json?     // Detailed breakdown of scoring

  // SEO Data
  seoData         Json?    @map("seo_data")
  // Structure: {
  //   keywords: [{ keyword: string, volume: number, difficulty: number }]
  //   relatedQueries: string[]
  //   trendData: object
  // }

  // Competitive Intelligence
  competitorData  Json?    @map("competitor_data")
  contentGap      Boolean? @default(false) @map("content_gap")

  // Trend Analysis
  trendData       Json?    @map("trend_data")
  trendDirection  String?  @map("trend_direction") // "rising", "stable", "declining"

  // Research Notes
  researchNotes   String?  @db.Text @map("research_notes")
  aiInsights      String?  @db.Text @map("ai_insights")

  // Status & Priority
  priority        String   @default("medium") // "low", "medium", "high", "urgent"
  status          String   @default("new")    // "new", "researching", "validated", "queued", "in_production", "published", "archived"
  reviewStatus    String?  @map("review_status") // "pending", "approved", "rejected"
  notes           String?  @db.Text

  // Validation
  isValidated     Boolean   @default(false) @map("is_validated")
  validatedAt     DateTime? @map("validated_at")
  validatedBy     String?   @map("validated_by")

  // Duplicate Detection
  similarIdeas    String[]  @map("similar_ideas") // IDs of similar/duplicate ideas
  isDuplicate     Boolean   @default(false) @map("is_duplicate")
  parentIdeaId    String?   @map("parent_idea_id")

  // Timestamps
  createdAt       DateTime @default(now()) @map("created_at")
  updatedAt       DateTime @updatedAt @map("updated_at")

  // Relationships
  user            User            @relation(fields: [userId], references: [id], onDelete: Cascade)
  brand           Brand?          @relation(fields: [brandId], references: [id], onDelete: SetNull)
  contentQueue    ContentQueue[]

  @@index([userId, status])
  @@index([brandId, status, overallScore])
  @@index([source])
  @@index([status])
  @@index([overallScore])
  @@index([discoveredAt])
  @@index([sourceId, source]) // For duplicate detection
  @@map("ideas")
}

// Discovery configurations per brand
model DiscoveryConfig {
  id              String    @id @default(uuid())
  brandId         String    @unique @map("brand_id")

  // Enabled Sources
  enabledSources  String[]  @map("enabled_sources") // reddit, youtube, twitter, etc.

  // Reddit Configuration
  redditConfig    Json?     @map("reddit_config") // subreddits, filters, keywords

  // YouTube Configuration
  youtubeConfig   Json?     @map("youtube_config") // channels, keywords, filters

  // Twitter Configuration
  twitterConfig   Json?     @map("twitter_config") // accounts, hashtags, keywords

  // SEO Configuration
  seoConfig       Json?     @map("seo_config") // target keywords, competitors

  // Firecrawl Configuration
  firecrawlConfig Json?     @map("firecrawl_config") // URLs to scrape

  // Scoring Weights (0-1, should sum to 1)
  scoringWeights  Json      @map("scoring_weights") // virality, relevance, competition, timeliness

  // Filters
  minScore        Float?    @default(50) @map("min_score") // Minimum overall score to save
  excludeKeywords String[]  @map("exclude_keywords") // Filter out unwanted topics

  // Schedule
  discoverySchedule Json?   @map("discovery_schedule") // When to run discovery

  // Limits
  maxIdeasPerDay  Int?      @default(50) @map("max_ideas_per_day")

  brand           Brand     @relation(fields: [brandId], references: [id], onDelete: Cascade)

  createdAt       DateTime  @default(now()) @map("created_at")
  updatedAt       DateTime  @updatedAt @map("updated_at")

  @@map("discovery_configs")
}

// Discovery run logs
model DiscoveryRun {
  id              String    @id @default(uuid())
  brandId         String    @map("brand_id")

  source          String    // Which source was scraped
  status          String    // running, completed, failed

  startedAt       DateTime  @map("started_at")
  completedAt     DateTime? @map("completed_at")

  // Results
  ideasFound      Int       @default(0) @map("ideas_found")
  ideasSaved      Int       @default(0) @map("ideas_saved")
  ideasFiltered   Int       @default(0) @map("ideas_filtered") // Below threshold

  // Error tracking
  errorMessage    String?   @db.Text @map("error_message")
  errorCount      Int       @default(0) @map("error_count")

  // Metadata
  metadata        Json?     // Source-specific metadata

  brand           Brand     @relation(fields: [brandId], references: [id], onDelete: Cascade)

  createdAt       DateTime  @default(now()) @map("created_at")

  @@index([brandId, source, startedAt])
  @@map("discovery_runs")
}

// ============================================
// CONTENT PRODUCTION QUEUE
// ============================================

model ContentQueue {
  id              String    @id @default(uuid())
  userId          String    @map("user_id")
  brandId         String?   @map("brand_id")
  ideaId          String?   @map("idea_id")

  // Job Configuration
  jobId           String?   @unique @map("job_id") // BullMQ job ID
  platform        String    // "blog", "youtube", "linkedin", "twitter"
  contentType     String    @map("content_type") // "blog_post", "video_script", "social_post"

  // Generation Settings
  generationConfig Json?    @map("generation_config")
  // Structure: {
  //   aiModel: "claude-sonnet-4.5" | "gpt-4"
  //   temperature: number
  //   maxTokens: number
  //   customPrompt: string
  // }

  // Status Tracking
  status          String    @default("queued") // "queued", "processing", "review", "approved", "failed"
  progress        Float?    @default(0)        // 0-100
  errorMessage    String?   @map("error_message") @db.Text

  // Content Brief (pre-generation)
  brief           Json?
  // Structure: {
  //   outline: string[]
  //   keyPoints: string[]
  //   research: object
  //   targetWordCount: number
  // }

  // Publishing Schedule
  scheduledFor    DateTime? @map("scheduled_for")

  // Timestamps
  createdAt       DateTime  @default(now()) @map("created_at")
  updatedAt       DateTime  @updatedAt @map("updated_at")

  // Relationships
  user            User                @relation(fields: [userId], references: [id], onDelete: Cascade)
  brand           Brand?              @relation(fields: [brandId], references: [id], onDelete: SetNull)
  idea            Idea?               @relation(fields: [ideaId], references: [id], onDelete: SetNull)
  generatedContent GeneratedContent[]

  @@index([userId, status])
  @@index([brandId])
  @@index([status])
  @@index([scheduledFor])
  @@map("content_queue")
}

// ============================================
// GENERATED CONTENT
// ============================================

model GeneratedContent {
  id              String   @id @default(uuid())
  queueId         String   @map("queue_id")
  userId          String   @map("user_id")
  brandId         String?  @map("brand_id")

  // Content
  contentType     String   @map("content_type") // "blog_post", "video_script", "social_post", "email"
  platform        String
  title           String?
  body            String?  @db.Text
  excerpt         String?  @db.Text

  // Metadata
  metadata        Json?
  // Structure: {
  //   wordCount: number
  //   readingTime: number
  //   tags: string[]
  //   categories: string[]
  // }

  // SEO
  seoData         Json?    @map("seo_data")
  // Structure: {
  //   metaTitle: string
  //   metaDescription: string
  //   slug: string
  //   focusKeyword: string
  //   titleVariations: string[]
  // }

  // Media
  mediaAssets     String[] @map("media_assets") // Array of media IDs

  // AI Tracking
  aiMetadata      Json?    @map("ai_metadata")
  // Structure: {
  //   model: string
  //   tokensUsed: number
  //   cost: number
  //   parameters: object
  //   generatedAt: string
  // }

  // Versions
  version         Int      @default(1)
  parentId        String?  @map("parent_id")

  // Status
  status          String   @default("draft") // "draft", "review", "approved", "published"

  // Quality Scores
  qualityScore    Float?   @map("quality_score")
  readabilityScore Float?  @map("readability_score")
  seoScore        Float?   @map("seo_score")

  // Timestamps
  createdAt       DateTime @default(now()) @map("created_at")
  updatedAt       DateTime @updatedAt @map("updated_at")

  // Relationships
  queue           ContentQueue  @relation(fields: [queueId], references: [id], onDelete: Cascade)
  brand           Brand?        @relation(fields: [brandId], references: [id], onDelete: SetNull)
  publications    Publication[]

  @@index([queueId])
  @@index([brandId])
  @@index([userId, status])
  @@index([platform, status])
  @@map("generated_content")
}

// ============================================
// MEDIA LIBRARY
// ============================================

model Media {
  id              String   @id @default(uuid())
  userId          String   @map("user_id")
  brandId         String?  @map("brand_id")

  // File Information
  type            String   // "image", "video", "audio"
  url             String
  thumbnailUrl    String?  @map("thumbnail_url")
  filename        String
  filesize        Int?     // bytes
  mimeType        String   @map("mime_type")

  // Dimensions
  width           Int?
  height          Int?
  duration        Float?   // seconds (for video/audio)

  // Generation Info
  generatedBy     String?  @map("generated_by") // "dalle", "stability", "elevenlabs", "manual"
  prompt          String?  @db.Text
  generationConfig Json?   @map("generation_config")

  // Organization
  tags            String[]
  description     String?  @db.Text

  // Usage
  usageCount      Int      @default(0) @map("usage_count")

  // Timestamps
  createdAt       DateTime @default(now()) @map("created_at")
  updatedAt       DateTime @updatedAt @map("updated_at")

  @@index([userId, type])
  @@index([brandId])
  @@index([generatedBy])
  @@map("media")
}

// ============================================
// PUBLISHING & DISTRIBUTION
// ============================================

model Publication {
  id              String    @id @default(uuid())
  userId          String    @map("user_id")
  brandId         String?   @map("brand_id")
  contentId       String    @map("content_id")
  integrationId   String?   @map("integration_id") // Which integration was used for publishing

  // Platform Details
  platform        String    // "sanity", "youtube", "linkedin", "twitter"
  platformPostId  String?   @map("platform_post_id")
  publishedUrl    String?   @map("published_url")

  // Status
  status          String    @default("scheduled") // "scheduled", "published", "failed"
  errorMessage    String?   @map("error_message") @db.Text

  // Performance Metrics
  performanceMetrics Json?  @map("performance_metrics")
  // Structure: {
  //   views: number
  //   clicks: number
  //   shares: number
  //   likes: number
  //   comments: number
  //   engagementRate: number
  // }

  // Timestamps
  scheduledFor    DateTime? @map("scheduled_for")
  publishedAt     DateTime? @map("published_at")
  createdAt       DateTime  @default(now()) @map("created_at")
  updatedAt       DateTime  @updatedAt @map("updated_at")

  // Relationships
  user            User              @relation(fields: [userId], references: [id], onDelete: Cascade)
  brand           Brand?            @relation(fields: [brandId], references: [id], onDelete: SetNull)
  content         GeneratedContent  @relation(fields: [contentId], references: [id], onDelete: Cascade)

  @@index([userId, platform])
  @@index([brandId])
  @@index([platform, status])
  @@index([scheduledFor])
  @@index([publishedAt])
  @@map("publications")
}

// ============================================
// ANALYTICS
// ============================================

model Analytics {
  id              String   @id @default(uuid())
  publicationId   String   @map("publication_id")

  // Metrics
  platform        String
  views           Int      @default(0)
  clicks          Int      @default(0)
  shares          Int      @default(0)
  likes           Int      @default(0)
  comments        Int      @default(0)

  // Calculated Metrics
  engagementRate  Float?   @map("engagement_rate")
  ctr             Float?   // Click-through rate

  // Time-series Data
  metricsSnapshot Json?    @map("metrics_snapshot")

  // Date
  date            DateTime @default(now())
  createdAt       DateTime @default(now()) @map("created_at")
  updatedAt       DateTime @updatedAt @map("updated_at")

  @@index([publicationId])
  @@index([platform, date])
  @@map("analytics")
}

// ============================================
// INTEGRATION MANAGEMENT
// ============================================

// User's configured integrations (AI, publishing, media, etc.)
model Integration {
  id              String    @id @default(uuid())
  userId          String    @map("user_id")
  brandId         String?   @map("brand_id") // Optional: brand-specific integration

  // Integration Type & Provider
  category        String    // "ai_provider", "media_generation", "publishing", "analytics"
  provider        String    // "anthropic", "openai", "dalle", "midjourney", "sanity", "wordpress", "linkedin", etc.

  // Display Info
  displayName     String    @map("display_name")
  description     String?   @db.Text
  iconUrl         String?   @map("icon_url")

  // Configuration
  config          Json      // Provider-specific configuration (API keys, settings, etc.)
  // Structure varies by provider:
  // AI: { apiKey, model, temperature, maxTokens, endpoint }
  // Media: { apiKey, style, size, quality }
  // Publishing: { apiKey, siteUrl, credentials }

  // Capabilities
  capabilities    String[]  // ["text_generation", "image_generation", "video_generation", "publishing", etc.]

  // Status & Preferences
  enabled         Boolean   @default(true)
  isDefault       Boolean   @default(false) @map("is_default") // Default for this category
  priority        Int       @default(0)     // Higher priority = preferred choice

  // Usage Limits
  dailyLimit      Int?      @map("daily_limit")
  monthlyLimit    Int?      @map("monthly_limit")

  // Usage Tracking
  usageToday      Int       @default(0) @map("usage_today")
  usageThisMonth  Int       @default(0) @map("usage_this_month")
  lastUsed        DateTime? @map("last_used")
  lastResetDaily  DateTime? @map("last_reset_daily")
  lastResetMonthly DateTime? @map("last_reset_monthly")

  // Cost Tracking
  costPerUnit     Float?    @map("cost_per_unit") // Cost per 1000 tokens, image, etc.
  totalCost       Float     @default(0) @map("total_cost")

  // Health & Status
  status          String    @default("active") // "active", "error", "rate_limited", "disabled"
  lastError       String?   @db.Text @map("last_error")
  lastHealthCheck DateTime? @map("last_health_check")

  // Timestamps
  createdAt       DateTime  @default(now()) @map("created_at")
  updatedAt       DateTime  @updatedAt @map("updated_at")

  @@unique([userId, brandId, provider, category])
  @@index([userId, category, enabled])
  @@index([category, provider])
  @@index([enabled, isDefault])
  @@map("integrations")
}

// Integration usage logs
model IntegrationUsage {
  id              String   @id @default(uuid())
  integrationId   String   @map("integration_id")
  userId          String   @map("user_id")

  // Usage Details
  operation       String   // "text_generation", "image_generation", "publish", etc.
  unitsUsed       Int      @map("units_used") // tokens, images, API calls, etc.
  cost            Float    @default(0)

  // Context
  contentId       String?  @map("content_id")
  jobId           String?  @map("job_id")

  // Metadata
  metadata        Json?    // Operation-specific metadata

  // Performance
  duration        Int?     // milliseconds
  success         Boolean  @default(true)
  errorMessage    String?  @db.Text @map("error_message")

  // Timestamp
  createdAt       DateTime @default(now()) @map("created_at")

  @@index([integrationId, createdAt])
  @@index([userId, createdAt])
  @@index([operation])
  @@map("integration_usage")
}

// ============================================
// API CONFIGURATIONS (Legacy - kept for backward compatibility)
// ============================================

model ApiConfig {
  id              String    @id @default(uuid())
  userId          String?   @map("user_id")

  // Service Details
  serviceName     String    @map("service_name") // "anthropic", "openai", "reddit", etc.
  apiKey          String    @map("api_key")      // Encrypted
  endpoint        String?

  // Rate Limiting
  rateLimitPerHour Int?     @map("rate_limit_per_hour")
  rateLimitPerDay  Int?     @map("rate_limit_per_day")

  // Usage Tracking
  requestsThisHour Int      @default(0) @map("requests_this_hour")
  requestsToday    Int      @default(0) @map("requests_today")
  lastResetHour    DateTime? @map("last_reset_hour")
  lastResetDay     DateTime? @map("last_reset_day")

  // Status
  active          Boolean  @default(true)

  // Timestamps
  createdAt       DateTime @default(now()) @map("created_at")
  updatedAt       DateTime @updatedAt @map("updated_at")

  @@unique([userId, serviceName])
  @@index([serviceName])
  @@map("api_configs")
}

// ============================================
// JOB LOGS
// ============================================

model JobLog {
  id              String    @id @default(uuid())

  // Job Details
  jobId           String    @map("job_id")
  jobType         String    @map("job_type") // "content_generation", "research", "media_generation"

  // Status
  status          String    // "completed", "failed", "processing"
  startedAt       DateTime  @map("started_at")
  completedAt     DateTime? @map("completed_at")

  // Execution Details
  input           Json?
  output          Json?
  errorMessage    String?   @map("error_message") @db.Text
  errorStack      String?   @map("error_stack") @db.Text

  // Performance
  duration        Int?      // milliseconds
  retryCount      Int       @default(0) @map("retry_count")

  // Timestamp
  createdAt       DateTime  @default(now()) @map("created_at")

  @@index([jobType, status])
  @@index([startedAt])
  @@map("job_logs")
}
